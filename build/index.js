"use strict";(()=>{var w=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),M=1280,$=720;var a=class s{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){return this.x*=t,this.y*=t,this}copy(){return new s(this.x,this.y)}setFrom(t){this.x=t.x,this.y=t.y}get magnitude(){return Math.hypot(this.x,this.y)}setMagnitude(t){this.x===0&&this.y==0||this.multiply(t/this.magnitude)}static add(t,e){return new s(t.x+e.x,t.y+e.y)}static diff(t,e){return new s(t.x-e.x,t.y-e.y)}static scale(t,e){return new s(t.x*e,t.y*e)}static sqrDist(t,e){let i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static manhattanDist(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static dist(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}static lerp(t,e,i){return new s(t.x*(1-i)+e.x*i,t.y*(1-i)+e.y*i)}};var k=class{constructor(t,e){this.roomKey=t,this.direction=e}isExitEvent(){return!0}isOpenMapEvent(){return!1}};var K=(s,t,e)=>Math.min(e,Math.max(s,t)),f=s=>s>0?1:s===0?0:-1,E=(s,t)=>t*Math.floor(s/t);var m=class s{constructor(t,e,i,n){this.x1=t,this.y1=e,this.x2=i,this.y2=n}intersectsPoint(t){return this.x1<=t.x&&t.x<=this.x2&&this.y1<=t.y&&t.y<=this.y2}get width(){return this.x2-this.x1}get height(){return this.y2-this.y1}get midpoint(){return new a((this.x1+this.x2)/2,(this.y1+this.y2)/2)}xInRange(t){return this.x1<=t&&t<this.x2}yInRange(t){return this.y1<=t&&t<this.y2}intersectsRectangle(t){return t.x1<=this.x2&&this.x1<=t.x2&&t.y1<=this.y2&&this.y1<=t.y2}uncollideCircle(t){let e=K(t.position.x,this.x1,this.x2),i=K(t.position.y,this.y1,this.y2),n=new a(e,i),o=a.diff(t.position,n),c=o.magnitude||1;if(c>=t.radius){let l=a.diff(t.position,this.midpoint),b=this.width/2-Math.abs(l.x),y=this.height/2-Math.abs(l.y);return b<y?new a((b+t.radius)*f(l.x),0):new a(0,(y+t.radius)*f(l.y))}return a.scale(o,(t.radius-c)/c)}draw(t,e=0){t.fillRect(this.x1-e,this.y1-e,this.width+e*2,this.height+e*2)}stroke(t,e=0){t.strokeRectInset(this.x1,this.y1,this.width,this.height,e)}inset(t){return new s(this.x1+t,this.y1+t,this.x2-t,this.y2-t)}static widthForm(t,e,i,n){return new s(t,e,t+i,e+n)}static centerForm(t,e,i,n){return new s(t-i,e-n,t+i,e+n)}static aroundPoint(t,e,i){return new s(t.x-e,t.y-i,t.x+e,t.y+i)}static merged(t){let[e,i,n,o]=t.reduce(([c,l,b,y],g)=>[Math.min(g.x1,c),Math.min(g.y1,l),Math.max(g.x2,b),Math.max(g.y2,y)],[1/0,1/0,-1/0,-1/0]);return new s(e,i,n,o)}},S=class{constructor(t,e,i){this.center=t,this.radius=e,this.cornerCut=i}draw(t){t.fillOctagon(this.center.x,this.center.y,this.radius,this.cornerCut)}intersectsRectangle(t){if(!m.centerForm(this.center.x,this.center.y,this.radius,this.radius).intersectsRectangle(t))return!1;let i=t.midpoint;return Math.abs(i.x-this.center.x)+Math.abs(i.y-this.center.y)<(t.width+t.height)/2+this.radius*2-this.cornerCut}intersectsBy(t){let e=t.midpoint,i=Math.abs(this.center.x-e.x),n=Math.abs(this.center.y-e.y);return Math.max(0,Math.min(this.radius+t.width/2-i,this.radius+t.height/2-n))}collideRectangle(t){let e=t.midpoint,i=Math.abs(this.center.x-e.x),n=Math.abs(this.center.y-e.y);if(i>=this.radius+t.width/2||n>=this.radius+t.height/2)return;let o=(t.width+t.height)/2+this.radius*2-this.cornerCut;if(i+n>=o)return;if(this.intersectsRectangle(t)||console.error("Collision fuck up"),n<this.radius-this.cornerCut+t.height/2){let l=t.width/2+this.radius;this.center.x=e.x+l*f(this.center.x-e.x);return}if(i<this.radius-this.cornerCut+t.width/2){let l=t.height/2+this.radius;this.center.y=e.y+l*f(this.center.y-e.y);return}let c=o-(i+n);this.center.x+=c/2*f(this.center.x-e.x),this.center.y+=c/2*f(this.center.y-e.y)}};var J=Symbol("Up"),j=Symbol("Down"),Q=Symbol("Left"),tt=Symbol("Right"),et=Symbol("Jump"),it=Symbol("Interact"),nt=Symbol("Escape"),rt=Symbol("Map"),u={Down:j,Escape:nt,Interact:it,Jump:et,Left:Q,Right:tt,Up:J,Map:rt};var N=130,ht=N/1.2,T=class{constructor(t){this.collider=new S(t,14,6),this.velocity=new a(0,0),this.direction=new a(0,-1)}getCursorCell(){let t=this.direction;return t?new a(E(t.x,36),E(t.y,36)):null}onInput(t,e){if(t.isForKey(u.Interact)||t.isClick()){let i=this.getCursorCell();i&&e.interactOnCell(i)}}update(t,e,i){let n=e.getHorizontalAxis(),o=e.getVerticalAxis(),c=new a(n,o).multiply(ht);this.velocity.add(c.multiply(1));let l=this.velocity.magnitude;l>N&&this.velocity.multiply(N/l),c.x===0&&c.y===0&&this.velocity.multiply(.5);let b=this.velocity.copy().multiply(t);this.collider.center.add(b);for(let y of i.blocks)this.collider.collideRectangle(y);this.direction=a.add(e.mousePosition,i.camera),a.dist(this.direction,this.collider.center)>144&&(this.direction=null)}collideWithBlock(){}draw(t){let e=this.getCursorCell();e&&(t.setColor("#0005"),t.setLineWidth(2),t.strokeRect(e.x,e.y,36,36)),t.setColor("green"),this.collider.draw(t)}};var p=36*2,h=50,D=class{constructor(t,e,i){this.visited=!1;this.backgroundDirty=!0;this.key=t,this.width=E(e,2*36),this.height=E(i,2*36),this.collider=m.widthForm(0,0,e,i),this.camera=new a(this.width/2,this.height/2),this.player=new T(this.camera.copy()),this.blocks=[];for(let n=0;n<this.width;n+=36)for(let o=0;o<this.height;o+=36)Math.random()<.06&&this.blocks.push(new m(n,o,n+36,o+36));this.blocks.push(new m(-h,-h,this.width/2-p,0),new m(this.width/2+p,-h,this.width+h,0),new m(this.width,-h,this.width+h,this.height/2-p),new m(this.width,this.height/2+p,this.width+h,this.height+h),new m(this.width/2+p,this.height,this.width+h,this.height+h),new m(-h,this.height,this.width/2-p,this.height+h),new m(-h,this.height/2+p,0,this.height+h),new m(-h,-h,0,this.height/2-p)),this.exits=[[m.widthForm(this.width/2-p,-h,p*2,h),"up"],[m.widthForm(-h,this.height/2-p,h,p*2),"left"],[m.widthForm(this.width/2-p,this.height,p*2,h),"down"],[m.widthForm(this.width,this.height/2-p,h,p*2),"right"]]}start(){this.visited=!0,this.backgroundDirty=!0}update(t,e,i){this.player.update(t,e,this);let n=this.exits.find(([o])=>o.intersectsPoint(this.player.collider.center));n&&i.onLevelEvent(new k(this.key,n[1]))}onInput(t){this.player.onInput(t,this)}interactOnCell(t){let e=-1;for(let i=0;i<this.blocks.length;i++){let n=this.blocks[i];if(n.x1===t.x&&n.y1===t.y&&n.width===36&&n.height===36){e=i;break}}if(e===-1){let i=m.widthForm(t.x,t.y,36,36);if(!this.collider.intersectsPoint(i.midpoint))return;this.player.collider.intersectsBy(i)<5&&(this.backgroundDirty=!0,this.blocks.push(i))}else this.backgroundDirty=!0,this.blocks.splice(e,1)}draw(t){if(t.setCamera(this.camera.copy().add(new a(h,h))),this.backgroundDirty){this.backgroundDirty=!1;let i=t.staticWorldCanvas;i.clear(),i.translate(h,h),i.setColor("black"),i.setLineWidth(5),i.strokeRect(0,0,this.width,this.height),i.setColor("white"),i.fillRect(0,0,this.width,this.height),i.setColor("gray"),this.blocks.forEach(n=>n.draw(i)),i.translate(-h,-h)}let e=t.dynamicWorldCanvas;e.clear(),e.translate(h,h),this.player.draw(e),e.translate(-h,-h)}enterFrom(t){let i={up:new a(this.width/2,this.height-10),right:new a(10,this.height/2),down:new a(this.width/2,10),left:new a(this.width-10,this.height/2)};this.player.collider.center=i[t.direction],this.start()}};var ct=s=>{let[t,e]=s.split(",").map(i=>parseInt(i));return new a(t,e)},O=s=>`${s.x},${s.y}`,ut={up:new a(0,-1),down:new a(0,1),left:new a(-1,0),right:new a(1,0)},V=class{constructor(){this.map=new Map,this.currentRoom=this.createRoom(new a(0,0))}createRoom(t){let e=new D(O(t),900,600);return this.map.set(O(t),e),e}navigate(t){let{roomKey:e,direction:i}=t,n=a.add(ct(e),ut[i]),o=O(n);if(!this.map.get(e)){console.error("Exited a room that does not exist!",e,Array.from(this.map.keys()));return}let l=this.map.get(o);l?this.currentRoom=l:this.currentRoom=this.createRoom(n),this.currentRoom.enterFrom(t)}};var L=class{constructor(t){this.gameModeManager=t,this.roomWeb=new V,this.startLevel(this.roomWeb.currentRoom)}startLevel(t){t.start()}onStart(){this.roomWeb.currentRoom.start()}onLevelEvent(t){if(t.isExitEvent()){let e=t;this.roomWeb.navigate(e)}else t.isOpenMapEvent()}update(t,e){this.roomWeb.currentRoom.update(t,e,this)}onInput(t){this.roomWeb.currentRoom.onInput(t)}draw(t){this.roomWeb.currentRoom.draw(t)}};var mt=["horizontal-movement","vertical-movement","map-c","exit-c","zoom-c"],A=class{constructor(){this.playMode=new L(this),this.currentMode=this.playMode,this.playMode.onStart()}update(t,e){this.currentMode.update(t,e)}switchToMode(t){this.currentMode=t,t.onStart()}onInput(t){!1||this.currentMode.onInput(t)}draw(t){this.currentMode.draw(t)}enableSections(t){if(w){for(let e of mt)document.getElementById(e)?.classList.add("hidden");for(let e of t)document.getElementById(e)?.classList.remove("hidden")}}};var Z={" ":u.Jump,Escape:u.Escape,KeyW:u.Up,KeyA:u.Left,KeyS:u.Down,KeyD:u.Right,KeyE:u.Interact,KeyM:u.Map};function _(s){return window.TouchEvent&&s instanceof TouchEvent}var B=class s{constructor(t,e,i=!1,n=!1){this.keyMap=t,this.mousePosition=e,this.leftClicking=i,this.rightClicking=n}getHorizontalAxis(){return+!!this.keyMap[u.Right]-+!!this.keyMap[u.Left]}getVerticalAxis(){return+!!this.keyMap[u.Down]-+!!this.keyMap[u.Up]}isPressed(t){return!!this.keyMap[t]}isLeftClicking(){return this.leftClicking}isRightClicking(){return this.rightClicking}static empty(){return new s({},new a(0,0))}},I=class{constructor(){}isForKey(t){return!1}isClick(){return!1}isScroll(){return!1}},G=class extends I{constructor(e){super();this.input=e}isForKey(e){return e===this.input}},P=class extends I{constructor(e,i){super();this.position=e,this.isRight=i}isClick(){return!0}isRightClick(){return this.isRight}},C=class extends I{constructor(e,i){super();this.delta=e,this.discrete=!!i}isScroll(){return!0}},F=class{constructor(t){this.leftClicking=!1,this.rightClicking=!1,this.isButtonDown={},this.listener=t,this.mousePosition=new a(0,0),this.canvas=document.getElementById("canvas")}init(){let t=i=>{this.listener&&this.listener(new G(i))};document.addEventListener("keydown",i=>{let n=i.code;if(i.repeat)return;let o=Z[n];o&&(this.isButtonDown[o]=!0,t(o))}),document.addEventListener("keyup",i=>{let n=i.code,o=Z[n];o&&(this.isButtonDown[o]=!1)}),this.canvas.addEventListener(w?"touchmove":"mousemove",i=>{this.mousePosition=this.toCanvasPosition(i)}),this.canvas.addEventListener(w?"touchstart":"mousedown",i=>{w&&i.preventDefault(),this.mousePosition=this.toCanvasPosition(i);let n=_(i)||i instanceof MouseEvent&&i.button===0,o=i instanceof MouseEvent&&i.button===2;n?(this.listener?.(new P(this.mousePosition,!1)),this.leftClicking=!0):o&&(this.listener?.(new P(this.mousePosition,!0)),this.rightClicking=!0)}),this.canvas.addEventListener(w?"touchend":"mouseup",i=>{let n=_(i)||i instanceof MouseEvent&&i.button===0,o=i instanceof MouseEvent&&i.button===2;n?this.leftClicking=!1:o&&(this.rightClicking=!1)}),this.canvas.addEventListener("contextmenu",i=>{i.preventDefault()}),this.canvas.addEventListener(w?"touchend":"mouseleave",()=>{this.leftClicking=!1,this.rightClicking=!1}),this.canvas.addEventListener("wheel",i=>{this.listener?.(new C(i.deltaY))});let e=(i,n)=>{let o=document.getElementById(i);o&&(o.addEventListener("touchstart",c=>{c.preventDefault(),typeof n=="function"?this.listener?.(n()):(this.isButtonDown[n]=!0,t(n))}),o.addEventListener("touchcancel",c=>{c.preventDefault(),typeof n=="function"||(this.isButtonDown[n]=!1)}),o.addEventListener("touchend",c=>{c.preventDefault(),typeof n=="function"||(this.isButtonDown[n]=!1)}))};e("left",u.Left),e("right",u.Right),e("jump",u.Jump),e("down",u.Down),e("map",u.Map),e("exit",u.Escape),e("zoom-in",()=>new C(1,!0)),e("zoom-out",()=>new C(-1,!0))}toCanvasPosition(t){let e=_(t)?t.touches.item(0)||{clientX:0,clientY:0}:t;return a.scale(new a(e.clientX-this.canvas.offsetLeft+window.scrollX-this.canvas.clientWidth/2,e.clientY-this.canvas.offsetTop+window.scrollY-this.canvas.clientHeight/2),this.canvas.width/this.canvas.clientWidth*M/M)}getInputState(){return new B(this.isButtonDown,this.mousePosition,this.leftClicking,this.rightClicking)}};var lt="0",H=(s,t)=>s.toString(16).padStart(t,lt),z=(s,t,e,i=255)=>`#${H(s,2)}${H(t,2)}${H(e,2)}${H(i,2)}`,q=(s,t,e,i=1)=>`hsla(${s},${Math.floor(t*100)}%,${Math.floor(e*100)}%,${i})`;var r=Symbol("ctx"),R=Symbol("canvas"),x=class s{static{R,r}constructor(t){this[R]=t;let e=t.getContext("2d");if(!e)throw Error("Unable to get 2d context");e.imageSmoothingEnabled=!1,this[r]=e,this[r].fillStyle="black",this[r].strokeStyle="black",this.width=this[R].width,this.height=this[R].height}fillRect(t,e,i,n){this[r].fillRect(t,e,i,n)}clear(){this[r].clearRect(0,0,this.width,this.height)}strokeRect(t,e,i,n){this[r].strokeRect(t,e,i,n)}strokeRectInset(t,e,i,n,o){this.strokeRect(t+o,e+o,i-o*2,n-o*2)}fillEllipse(t,e,i,n){this[r].beginPath(),this[r].ellipse(t,e,i,n,0,0,2*Math.PI),this[r].fill()}fillTriangle(t,e,i,n){this[r].beginPath(),this[r].moveTo(t,e+n),this[r].lineTo(t+i,e+n),this[r].lineTo(t+i/2,e),this[r].fill()}strokeEllipse(t,e,i,n){this[r].beginPath(),this[r].ellipse(t,e,i,n,0,0,2*Math.PI),this[r].stroke()}fillDiamond(t,e,i,n){this[r].beginPath(),this[r].moveTo(t,e-n),this[r].lineTo(t+i,e),this[r].lineTo(t,e+n),this[r].lineTo(t-i,e),this[r].lineTo(t,e-n),this[r].fill()}fillOctagon(t,e,i,n){let o=i-n;this[r].beginPath(),this[r].moveTo(t-o,e-i),this[r].lineTo(t+o,e-i),this[r].lineTo(t+i,e-o),this[r].lineTo(t+i,e+o),this[r].lineTo(t+o,e+i),this[r].lineTo(t-o,e+i),this[r].lineTo(t-i,e+o),this[r].lineTo(t-i,e-o),this[r].lineTo(t-o,e-i),this[r].fill()}outerCircleCorner(t,e,i,n){this[r].beginPath(),this[r].arc(t,e,i,n,n+Math.PI/2);let o=n+Math.PI/4;this[r].lineTo(t+f(Math.cos(o))*i,e+f(Math.sin(o))*i),this[r].fill()}drawLine(t,e,i,n){this[r].beginPath(),this[r].moveTo(t,e),this[r].lineTo(i,n),this[r].stroke()}drawQuadratic(t,e,i,n,o,c){this[r].beginPath(),this[r].moveTo(t,e),this[r].quadraticCurveTo(o,c,i,n),this[r].stroke()}scale(t,e){this[r].scale(t,e)}translate(t,e){this[r].translate(t,e)}translateCenterTo(t,e){this[r].translate(-t+this.width/2,-e+this.height/2)}setLineWidth(t){this[r].lineWidth=t}get lineWidth(){return this[r].lineWidth}setLineDash(t){this[r].setLineDash(t)}setColor(t){t!==this[r].fillStyle&&(this[r].fillStyle=t,this[r].strokeStyle=t)}setColorRGB(t,e,i,n=255){this.setColor(z(t,e,i,n))}setColorHSLA(t,e,i,n=1){this.setColor(q(t,e,i,n))}createGradient(t,e,i,n){return this[r].createLinearGradient(t,e,i,n)}createRadialGradient(t,e,i,n,o,c){return this[r].createRadialGradient(t,e,i,n,o,c)}saveTransform(){this[r].save()}restoreTransform(){this[r].restore()}drawImage(t,e,i,n,o,c,l,b,y){let g;if(t instanceof s)g=t[R];else if(t instanceof Image){if(!t.complete)return;g=t}else throw Error("Drawing something unmanageable");this[r].drawImage(g,e,i,n,o,c,l,b,y)}static fromId(t){let e=document.getElementById(t);if(!e||!(e instanceof HTMLCanvasElement))throw new Error(`Could not find canvas with id: "${t}"`);return new s(e)}static fromScratch(t,e){let i=document.createElement("canvas");return i.width=t,i.height=e,new s(i)}};var v=Symbol("real-canvas");function dt(){let s=document.getElementById("canvas");if(!(s instanceof HTMLCanvasElement))throw new Error("Could not find canvas");return s.width=M,s.height=$,s}var W=class s{static{v}constructor(){let t=new x(dt());if(!(t instanceof x))throw Error("No canvas found!");this[v]=t,this.staticWorldCanvas=x.fromScratch(1280*3,720*4),this.dynamicWorldCanvas=x.fromScratch(1280*3,720*4),this.camera=new a(0,0)}setCamera(t){this.camera=t}drawCanvas(t,e,i=1280,n=720){this[v].drawImage(t,e.x-i/2,e.y-n/2,i,n,0,0,this[v].width,this[v].height)}drawToScreen(){this[v].clear(),this.drawCanvas(this.staticWorldCanvas,this.camera),this.drawCanvas(this.dynamicWorldCanvas,this.camera)}static{this.instance=null}static getInstance(){return this.instance?this.instance:new s}};var pt=1/20,X=class{constructor(){this.lastFrameTime=0;this.gameModeManager=new A,this.inputManager=new F(t=>this.onInput(t)),this.screenManager=new W,this.lastFrameTime=performance.now()}start(){this.inputManager.init(),requestAnimationFrame(()=>this.mainLoop())}onInput(t){this.gameModeManager.onInput(t)}mainLoop(){let t=performance.now(),e=Math.min((t-this.lastFrameTime)/1e3,pt);this.gameModeManager.update(e,this.inputManager.getInputState()),this.gameModeManager.draw(this.screenManager),this.screenManager.drawToScreen(),requestAnimationFrame(()=>this.mainLoop()),this.lastFrameTime=t}},ft=()=>{new X().start()};window.onload=()=>{ft()};})();
//# sourceMappingURL=index.js.map
