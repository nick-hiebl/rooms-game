"use strict";(()=>{var mt=Symbol("Up"),lt=Symbol("Down"),ut=Symbol("Left"),dt=Symbol("Right"),pt=Symbol("Jump"),ft=Symbol("Interact"),bt=Symbol("Escape"),yt=Symbol("Map"),d={Down:lt,Escape:bt,Interact:ft,Jump:pt,Left:ut,Right:dt,Up:mt,Map:yt};var E=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),k=1280,U=720;var R=(a,t,e)=>Math.min(e,Math.max(a,t)),x=a=>a>0?1:a===0?0:-1,w=(a,t)=>t*Math.floor(a/t),T=a=>Math.floor(Math.random()*a);function et(a){for(let t=a.length-1;t>0;t--){let e=T(t+1);[a[t],a[e]]=[a[e],a[t]]}return a}var wt="0",A=(a,t)=>a.toString(16).padStart(t,wt),ot=(a,t,e,o=255)=>`#${A(a,2)}${A(t,2)}${A(e,2)}${A(o,2)}`,it=(a,t,e,o=1)=>`hsla(${a},${Math.floor(t*100)}%,${Math.floor(e*100)}%,${o})`;var h=Symbol("ctx"),D=Symbol("canvas"),v=class a{static{D,h}constructor(t){this[D]=t;let e=t.getContext("2d");if(!e)throw Error("Unable to get 2d context");e.imageSmoothingEnabled=!1,this[h]=e,this[h].fillStyle="black",this[h].strokeStyle="black",this.width=this[D].width,this.height=this[D].height}fillRect(t,e,o,i){this[h].fillRect(t,e,o,i)}clear(){this[h].clearRect(0,0,this.width,this.height)}strokeRect(t,e,o,i){this[h].strokeRect(t,e,o,i)}strokeRectInset(t,e,o,i,n){this.strokeRect(t+n,e+n,o-n*2,i-n*2)}fillEllipse(t,e,o,i){this[h].beginPath(),this[h].ellipse(t,e,o,i,0,0,2*Math.PI),this[h].fill()}fillTriangle(t,e,o,i){this[h].beginPath(),this[h].moveTo(t,e+i),this[h].lineTo(t+o,e+i),this[h].lineTo(t+o/2,e),this[h].fill()}strokeEllipse(t,e,o,i){this[h].beginPath(),this[h].ellipse(t,e,o,i,0,0,2*Math.PI),this[h].stroke()}fillDiamond(t,e,o,i){this[h].beginPath(),this[h].moveTo(t,e-i),this[h].lineTo(t+o,e),this[h].lineTo(t,e+i),this[h].lineTo(t-o,e),this[h].lineTo(t,e-i),this[h].fill()}fillOctagon(t,e,o,i){let n=o-i;this[h].beginPath(),this[h].moveTo(t-n,e-o),this[h].lineTo(t+n,e-o),this[h].lineTo(t+o,e-n),this[h].lineTo(t+o,e+n),this[h].lineTo(t+n,e+o),this[h].lineTo(t-n,e+o),this[h].lineTo(t-o,e+n),this[h].lineTo(t-o,e-n),this[h].lineTo(t-n,e-o),this[h].fill()}outerCircleCorner(t,e,o,i){this[h].beginPath(),this[h].arc(t,e,o,i,i+Math.PI/2);let n=i+Math.PI/4;this[h].lineTo(t+x(Math.cos(n))*o,e+x(Math.sin(n))*o),this[h].fill()}drawLine(t,e,o,i){this[h].beginPath(),this[h].moveTo(t,e),this[h].lineTo(o,i),this[h].stroke()}drawQuadratic(t,e,o,i,n,r){this[h].beginPath(),this[h].moveTo(t,e),this[h].quadraticCurveTo(n,r,o,i),this[h].stroke()}scale(t,e){this[h].scale(t,e)}translate(t,e){this[h].translate(t,e)}translateCenterTo(t,e){this[h].translate(-t+this.width/2,-e+this.height/2)}setLineWidth(t){this[h].lineWidth=t}get lineWidth(){return this[h].lineWidth}setLineDash(t){this[h].setLineDash(t)}setColor(t){t!==this[h].fillStyle&&(this[h].fillStyle=t,this[h].strokeStyle=t)}setColorRGB(t,e,o,i=255){this.setColor(ot(t,e,o,i))}setColorHSLA(t,e,o,i=1){this.setColor(it(t,e,o,i))}createGradient(t,e,o,i){return this[h].createLinearGradient(t,e,o,i)}createRadialGradient(t,e,o,i,n,r){return this[h].createRadialGradient(t,e,o,i,n,r)}saveTransform(){this[h].save()}restoreTransform(){this[h].restore()}drawImage(t,e,o,i,n,r,c,l,u){let m;if(t instanceof a)m=t[D];else if(t instanceof Image){if(!t.complete)return;m=t}else throw Error("Drawing something unmanageable");this[h].drawImage(m,e,o,i,n,r,c,l,u)}static fromId(t){let e=document.getElementById(t);if(!e||!(e instanceof HTMLCanvasElement))throw new Error(`Could not find canvas with id: "${t}"`);return new a(e)}static fromScratch(t,e){let o=document.createElement("canvas");return o.width=t,o.height=e,new a(o)}};var s=class a{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){return this.x*=t,this.y*=t,this}copy(){return new a(this.x,this.y)}setFrom(t){this.x=t.x,this.y=t.y}get magnitude(){return Math.hypot(this.x,this.y)}setMagnitude(t){this.x===0&&this.y==0||this.multiply(t/this.magnitude)}static add(t,e){return new a(t.x+e.x,t.y+e.y)}static diff(t,e){return new a(t.x-e.x,t.y-e.y)}static scale(t,e){return new a(t.x*e,t.y*e)}static sqrDist(t,e){let o=t.x-e.x,i=t.y-e.y;return o*o+i*i}static manhattanDist(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static dist(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}static lerp(t,e,o){return new a(t.x*(1-o)+e.x*o,t.y*(1-o)+e.y*o)}};var nt=document.location.toString().includes("localhost"),$=.5,st=.05,gt=.001,at=[.05,.1,.15,.2,.3,.5],ht=at.slice();ht.reverse();var _=60,rt=10,H=class{constructor(t){this.gameModeManager=t,this.playMode=t.playMode,this.cameraPosition=new s(0,0),this.setCameraPos(),this.zoom=$,this.mousePosition=new s(0,0),this.isClicked=!1,this.hoverPosition=new s(0,0),this.canvasW=0,this.canvasH=0,this.roomCanvasMap=new Map,this.drawIcons=[]}setCameraPos(){let t=this.playMode.roomWeb.currentRoom;this.cameraPosition=s.add(this.getRoomPosition(t),new s(t.width/2,t.height/2))}onStart(){this.setCameraPos(),this.mousePosition=new s(0,0),this.isClicked=!1,this.hoverPosition=new s(0,0),this.predrawRooms(),this.drawIcons=this.getIconsToShow()}getIconsToShow(){return[]}predrawRooms(){for(let t of this.playMode.roomWeb.rooms){if(!nt&&!t.visited)continue;let e=this.roomCanvasMap.get(t.key)||v.fromScratch(t.width*1/36*rt,t.height*1/36*rt);t.drawForMap(e),this.roomCanvasMap.set(t.key,e)}}toWorldPosition(t){return s.add(s.scale(t,1/this.zoom),this.cameraPosition)}update(t,e){let o=this.toWorldPosition(e.mousePosition);this.hoverPosition=this.toWorldPosition(e.mousePosition);let i;for(let n of this.drawIcons){if(i){n.isHovered=!1;continue}s.sqrDist(n.position,o)<32?(n.isHovered=!0,i=n):n.isHovered=!1}e.isLeftClicking()&&this.isClicked?this.cameraPosition.subtract(s.diff(o,this.mousePosition)):this.isClicked=!1}onInput(t){if(t.isClick()){let e=t;if(!e.isRightClick()){this.mousePosition=this.toWorldPosition(e.position),this.isClicked=!0;let o=this.toWorldPosition(e.position),i=this.positionToRoomIndex(o);if(!this.playMode.roomWeb.getRoom(i)){let n=this.playMode.roomWeb.createRoom(i,2,2);n&&!this.roomCanvasMap.get(n.key)&&this.predrawRooms()}}}else if(t.isScroll()){let e=t;e.discrete?e.delta>0?this.zoom=at.find(o=>o>this.zoom)||$:this.zoom=ht.find(o=>o<this.zoom)||st:this.zoom=R(this.zoom+e.delta*-gt,st,$)}}getRoomPosition(t){let{x:e,y:o}=t.position;return new s(e*864,o*576)}positionToRoomIndex(t){let e=new s(w(t.x,864),w(t.y,576));return new s(e.x/864,e.y/576)}draw(t){let e=this.playMode.roomWeb.currentRoom,o=t.uiCanvas;this.canvasW=o.width,this.canvasH=o.height,o.setColor("black"),o.fillRect(0,0,o.width,o.height),o.saveTransform(),o.translate(o.width/2,o.height/2),o.scale(this.zoom,this.zoom),o.translate(-this.cameraPosition.x,-this.cameraPosition.y);let i=e.player;for(let r of this.playMode.roomWeb.rooms){let c=this.roomCanvasMap.get(r.key);if(!nt&&!r.visited||!c)continue;let l=this.getRoomPosition(r);o.drawImage(c,0,0,c.width,c.height,l.x,l.y,r.width,r.height)}let n=new s(w(this.hoverPosition.x,864),w(this.hoverPosition.y,576));if(o.setColor("#fff6"),o.setLineWidth(4),o.strokeRect(n.x,n.y,864,576),i){let r=this.getRoomPosition(e),c=s.add(r,new s(e.width/2,e.height/2));o.translate(c.x,c.y),o.setLineWidth(8),o.setLineDash([]),o.setColor("white"),o.fillEllipse(0,0,_,_),o.setColor("black"),o.strokeEllipse(0,0,_,_),o.translate(-c.x,-c.y)}o.setColor("pink"),o.fillEllipse(this.hoverPosition.x,this.hoverPosition.y,5,5),o.restoreTransform()}};var I=class{constructor(t,e,o){this.fromKey=t,this.toKey=e,this.direction=o}isExitEvent(){return!0}isOpenMapEvent(){return!1}};var f=class a{constructor(t,e,o,i){this.x1=t,this.y1=e,this.x2=o,this.y2=i}intersectsPoint(t){return this.x1<=t.x&&t.x<=this.x2&&this.y1<=t.y&&t.y<=this.y2}get width(){return this.x2-this.x1}get height(){return this.y2-this.y1}get midpoint(){return new s((this.x1+this.x2)/2,(this.y1+this.y2)/2)}xInRange(t){return this.x1<=t&&t<this.x2}yInRange(t){return this.y1<=t&&t<this.y2}intersectsRectangle(t){return t.x1<=this.x2&&this.x1<=t.x2&&t.y1<=this.y2&&this.y1<=t.y2}uncollideCircle(t){let e=R(t.position.x,this.x1,this.x2),o=R(t.position.y,this.y1,this.y2),i=new s(e,o),n=s.diff(t.position,i),r=n.magnitude||1;if(r>=t.radius){let c=s.diff(t.position,this.midpoint),l=this.width/2-Math.abs(c.x),u=this.height/2-Math.abs(c.y);return l<u?new s((l+t.radius)*x(c.x),0):new s(0,(u+t.radius)*x(c.y))}return s.scale(n,(t.radius-r)/r)}draw(t,e=0){t.fillRect(this.x1-e,this.y1-e,this.width+e*2,this.height+e*2)}stroke(t,e=0){t.strokeRectInset(this.x1,this.y1,this.width,this.height,e)}inset(t){return new a(this.x1+t,this.y1+t,this.x2-t,this.y2-t)}static widthForm(t,e,o,i){return new a(t,e,t+o,e+i)}static centerForm(t,e,o,i){return new a(t-o,e-i,t+o,e+i)}static aroundPoint(t,e,o){return new a(t.x-e,t.y-o,t.x+e,t.y+o)}static merged(t){let[e,o,i,n]=t.reduce(([r,c,l,u],m)=>[Math.min(m.x1,r),Math.min(m.y1,c),Math.max(m.x2,l),Math.max(m.y2,u)],[1/0,1/0,-1/0,-1/0]);return new a(e,o,i,n)}},O=class{constructor(t,e,o){this.center=t,this.radius=e,this.cornerCut=o}draw(t){t.fillOctagon(this.center.x,this.center.y,this.radius,this.cornerCut)}intersectsRectangle(t){if(!f.centerForm(this.center.x,this.center.y,this.radius,this.radius).intersectsRectangle(t))return!1;let o=t.midpoint;return Math.abs(o.x-this.center.x)+Math.abs(o.y-this.center.y)<(t.width+t.height)/2+this.radius*2-this.cornerCut}intersectsBy(t){let e=t.midpoint,o=Math.abs(this.center.x-e.x),i=Math.abs(this.center.y-e.y);return Math.max(0,Math.min(this.radius+t.width/2-o,this.radius+t.height/2-i))}collideRectangle(t){let e=t.midpoint,o=Math.abs(this.center.x-e.x),i=Math.abs(this.center.y-e.y);if(o>=this.radius+t.width/2||i>=this.radius+t.height/2)return;let n=(t.width+t.height)/2+this.radius*2-this.cornerCut;if(o+i>=n)return;this.intersectsRectangle(t)||console.error("Collision fuck up");let r=t.width/2+this.radius,c=e.x+r*x(this.center.x-e.x),l=Math.abs(this.center.x-c),u=t.height/2+this.radius,m=e.y+u*x(this.center.y-e.y),C=Math.abs(this.center.y-m);if(i<this.radius-this.cornerCut+t.height/2||o<this.radius-this.cornerCut+t.width/2){l<C?this.center.x=c:this.center.y=m;return}let tt=n-(o+i);this.center.x+=tt/2*x(this.center.x-e.x),this.center.y+=tt/2*x(this.center.y-e.y)}};var X=500,Ct=X/1.2,F=class{constructor(t){this.collider=new O(t,14,6),this.velocity=new s(0,0),this.direction=new s(0,-1)}getCursorCell(){let t=this.direction;return t?new s(w(t.x,36),w(t.y,36)):null}onInput(t,e){if(t.isForKey(d.Interact)||t.isClick()){let o=this.getCursorCell();o&&e.interactOnCell(o)}}update(t,e,o){let i=e.getHorizontalAxis(),n=e.getVerticalAxis(),r=new s(i,n).multiply(Ct);this.velocity.add(r.multiply(1));let c=this.velocity.magnitude;c>X&&this.velocity.multiply(X/c),r.x===0&&r.y===0&&this.velocity.multiply(.5);let l=this.velocity.copy().multiply(t);this.collider.center.add(l);for(let u of o.blocks)this.collider.collideRectangle(u);this.direction=s.add(e.mousePosition,o.camera),s.dist(this.direction,this.collider.center)>144&&(this.direction=null)}collideWithBlock(){}draw(t){let e=this.getCursorCell();e&&(t.setColor("#0005"),t.setLineWidth(2),t.strokeRect(e.x,e.y,36,36)),t.setColor("green"),this.collider.draw(t)}};var Et=36*2,g=50,K=class{constructor(t,e,o){this.visited=!1;this.backgroundDirty=!0;this.color=`hsl(${T(360)}, ${T(20)+50}%, ${T(30)+60}%)`,this.key=M(t),this.width=w(e,864),this.height=w(o,576),this.position=t,this.collider=f.widthForm(0,0,this.width,this.height),this.camera=new s(this.width/2,this.height/2),this.player=new F(this.camera.copy()),this.blocks=[];for(let m=36;m<this.width-36;m+=36)for(let C=36;C<this.height-36;C+=36)Math.random()<.02&&this.blocks.push(new f(m,C,m+36,C+36));let i=this.width/864,n=this.height/576,r=g,c=Et,l=864,u=576;this.exits=[];for(let m=0;m<i;m++)this.blocks.push(f.widthForm(-r+m*l,-r,l/2-c+r,r),f.widthForm((m+1/2)*l+c,-r,l/2-c+r,r),f.widthForm(-r+m*l,n*u,l/2-c+r,r),f.widthForm((m+1/2)*l+c,n*u,l/2-c+r,r)),this.exits.push([f.widthForm((m+1/2)*l-c,-r,c*2,r),new I(this.position,new s(this.position.x+m,this.position.y-1),"up")],[f.widthForm((m+1/2)*l-c,n*u,c*2,r),new I(this.position,new s(this.position.x+m,this.position.y+n),"down")]);for(let m=0;m<n;m++)this.blocks.push(f.widthForm(-r,-r+m*u,r,u/2-c+r),f.widthForm(-r,(m+1/2)*u+c,r,u/2-c+r),f.widthForm(i*l,-r+m*u,r,u/2-c+r),f.widthForm(i*l,(m+1/2)*u+c,r,u/2-c+r)),this.exits.push([f.widthForm(-r,(m+1/2)*u-c,r,c*2),new I(this.position,new s(this.position.x-1,this.position.y+m),"left")],[f.widthForm(i*l,(m+1/2)*u-c,r,c*2),new I(this.position,new s(this.position.x+i,this.position.y+m),"right")])}start(){this.visited=!0,this.backgroundDirty=!0}update(t,e,o){this.player.update(t,e,this);let i=this.exits.find(([n])=>n.intersectsPoint(this.player.collider.center));i&&o.onLevelEvent(i[1]),this.camera=this.player.collider.center.copy(),this.camera.x=R(this.camera.x,864/2,this.width-864/2),this.camera.y=R(this.camera.y,576/2,this.height-576/2)}onInput(t){this.player.onInput(t,this)}interactOnCell(t){let e=-1;for(let o=0;o<this.blocks.length;o++){let i=this.blocks[o];if(i.x1===t.x&&i.y1===t.y&&i.width===36&&i.height===36){e=o;break}}if(e!==-1){this.backgroundDirty=!0,this.blocks.splice(e,1);return}else{let o=f.widthForm(t.x,t.y,36,36);if(!this.collider.intersectsPoint(o.midpoint)||this.exits.some(([n])=>n.intersectsRectangle(o)))return;this.player.collider.intersectsBy(o)<5&&(this.backgroundDirty=!0,this.blocks.push(o))}}draw(t){if(t.setCamera(this.camera.copy().add(new s(g,g))),t.uiCanvas.clear(),this.backgroundDirty){this.backgroundDirty=!1;let o=t.staticWorldCanvas;o.clear(),o.translate(g,g),o.setColor("black"),o.setLineWidth(5),o.strokeRect(0,0,this.width,this.height),o.setColor(this.color),o.fillRect(0,0,this.width,this.height),o.setColor("gray"),this.blocks.forEach(i=>i.draw(o)),o.translate(-g,-g)}let e=t.dynamicWorldCanvas;e.clear(),e.translate(g,g),this.player.draw(e),e.translate(-g,-g)}drawForMap(t){let o=i=>t.fillRect(i*4,i*4,t.width-i*4*2,t.height-i*4*2);t.setColor("grey"),o(1),t.setColor(this.color),o(2)}enterFrom(t){let o={up:new s(864/2,576-10),right:new s(10,576/2),down:new s(864/2,10),left:new s(864-10,576/2)},i=s.diff(t.toKey,this.position);this.player.collider.center=s.add(new s(i.x*864,i.y*576),o[t.direction]),this.start()}};var Rt=a=>{let[t,e]=a.split(",").map(o=>parseInt(o));return new s(t,e)},M=a=>`${a.x},${a.y}`,It=a=>{let t=[[new s(-2,0),3,1],[new s(-1,0),3,1],[new s(0,0),3,1],[new s(0,-2),1,3],[new s(0,-1),1,3],[new s(0,0),1,3],[new s(0,0),1,1]];switch(a){case"up":t.push([new s(-1,-1),2,2],[new s(0,-1),2,2]);break;case"left":t.push([new s(-1,-1),2,2],[new s(-1,0),2,2]);break;case"down":t.push([new s(-1,0),2,2],[new s(0,0),2,2]);break;case"right":t.push([new s(0,-1),2,2],[new s(0,0),2,2]);break}return et(t)},de={up:new s(0,-1),down:new s(0,1),left:new s(-1,0),right:new s(1,0)},G=class{constructor(){this.map=new Map,this.rooms=[],this.currentRoom=this.createRoomWithoutCheckingNeighbors(new s(0,0))}getRoom(t){return this.map.get(M(t))}createRoom(t,e=1,o=1){let i=!1;for(let n=0;n<e;n++){let r=M(new s(t.x+n,t.y-1)),c=M(new s(t.x+n,t.y+o));if(this.map.has(r)||this.map.has(c)){i=!0;break}}if(!i)for(let n=0;n<o;n++){let r=M(new s(t.x-1,t.y+n)),c=M(new s(t.x+e,t.y+n));if(this.map.has(r)||this.map.has(c)){i=!0;break}}if(i){for(let n=0;n<e;n++)for(let r=0;r<o;r++){let c=M(new s(t.x+n,t.y+r));if(this.map.get(c))return}return this.createRoomWithoutCheckingNeighbors(t,e,o)}}createRoomWithoutCheckingNeighbors(t,e=1,o=1){let i=[];for(let r=0;r<e;r++)for(let c=0;c<o;c++){let l=M(new s(t.x+r,t.y+c));if(i.push(l),this.map.get(l))throw console.error("Asked to create an overlapping room!"),Error()}let n=new K(t,864*e,576*o);for(let r of i)this.map.set(r,n);return this.rooms.push(n),n}currentRoomPosition(){return Rt(this.currentRoom.key)}navigate(t){let{direction:e,fromKey:o,toKey:i}=t,n=M(i);if(!this.map.get(M(o))){console.error("Exited a room that does not exist!",o,Array.from(this.map.keys()));return}let c=this.map.get(n);if(c)this.currentRoom=c;else{let l;for(let[u,m,C]of It(e))if(l=this.createRoom(s.add(i,u),m,C),l)break;l||(l=this.createRoom(i,1,1)),l||console.error("Failed creating new room!",i),this.currentRoom=l}this.currentRoom.enterFrom(t)}};var N=class{constructor(t){this.gameModeManager=t,this.roomWeb=new G,this.startLevel(this.roomWeb.currentRoom)}startLevel(t){t.start()}onStart(){this.roomWeb.currentRoom.start()}onLevelEvent(t){if(t.isExitEvent()){let e=t;this.roomWeb.navigate(e)}else t.isOpenMapEvent()}update(t,e){this.roomWeb.currentRoom.update(t,e,this)}onInput(t){this.roomWeb.currentRoom.onInput(t)}draw(t){this.roomWeb.currentRoom.draw(t)}};var kt=["horizontal-movement","vertical-movement","map-c","exit-c","zoom-c"],B=class{constructor(){this.playMode=new N(this),this.mapMode=new H(this),this.currentMode=this.playMode,this.playMode.onStart()}update(t,e){this.currentMode.update(t,e)}switchToMode(t){this.currentMode=t,t.onStart()}onInput(t){let e=!1;this.currentMode===this.playMode?t.isForKey(d.Map)&&(e=!0,this.switchToMode(this.mapMode)):this.currentMode===this.mapMode&&(t.isForKey(d.Escape)||t.isForKey(d.Map))&&(e=!1,this.switchToMode(this.playMode)),e||this.currentMode.onInput(t)}draw(t){this.currentMode.draw(t)}enableSections(t){if(E){for(let e of kt)document.getElementById(e)?.classList.add("hidden");for(let e of t)document.getElementById(e)?.classList.remove("hidden")}}};var ct={" ":d.Jump,Escape:d.Escape,KeyW:d.Up,KeyA:d.Left,KeyS:d.Down,KeyD:d.Right,KeyE:d.Interact,KeyM:d.Map};function q(a){return window.TouchEvent&&a instanceof TouchEvent}var J=class a{constructor(t,e,o=!1,i=!1){this.keyMap=t,this.mousePosition=e,this.leftClicking=o,this.rightClicking=i}getHorizontalAxis(){return+!!this.keyMap[d.Right]-+!!this.keyMap[d.Left]}getVerticalAxis(){return+!!this.keyMap[d.Down]-+!!this.keyMap[d.Up]}isPressed(t){return!!this.keyMap[t]}isLeftClicking(){return this.leftClicking}isRightClicking(){return this.rightClicking}static empty(){return new a({},new s(0,0))}},V=class{constructor(){}isForKey(t){return!1}isClick(){return!1}isScroll(){return!1}},j=class extends V{constructor(e){super();this.input=e}isForKey(e){return e===this.input}},Y=class extends V{constructor(e,o){super();this.position=e,this.isRight=o}isClick(){return!0}isRightClick(){return this.isRight}},P=class extends V{constructor(e,o){super();this.delta=e,this.discrete=!!o}isScroll(){return!0}},z=class{constructor(t){this.leftClicking=!1,this.rightClicking=!1,this.isButtonDown={},this.listener=t,this.mousePosition=new s(0,0),this.canvas=document.getElementById("canvas")}init(){let t=o=>{this.listener&&this.listener(new j(o))};document.addEventListener("keydown",o=>{let i=o.code;if(o.repeat)return;let n=ct[i];n&&(this.isButtonDown[n]=!0,t(n))}),document.addEventListener("keyup",o=>{let i=o.code,n=ct[i];n&&(this.isButtonDown[n]=!1)}),this.canvas.addEventListener(E?"touchmove":"mousemove",o=>{this.mousePosition=this.toCanvasPosition(o)}),this.canvas.addEventListener(E?"touchstart":"mousedown",o=>{E&&o.preventDefault(),this.mousePosition=this.toCanvasPosition(o);let i=q(o)||o instanceof MouseEvent&&o.button===0,n=o instanceof MouseEvent&&o.button===2;i?(this.listener?.(new Y(this.mousePosition,!1)),this.leftClicking=!0):n&&(this.listener?.(new Y(this.mousePosition,!0)),this.rightClicking=!0)}),this.canvas.addEventListener(E?"touchend":"mouseup",o=>{let i=q(o)||o instanceof MouseEvent&&o.button===0,n=o instanceof MouseEvent&&o.button===2;i?this.leftClicking=!1:n&&(this.rightClicking=!1)}),this.canvas.addEventListener("contextmenu",o=>{o.preventDefault()}),this.canvas.addEventListener(E?"touchend":"mouseleave",()=>{this.leftClicking=!1,this.rightClicking=!1}),this.canvas.addEventListener("wheel",o=>{this.listener?.(new P(o.deltaY))});let e=(o,i)=>{let n=document.getElementById(o);n&&(n.addEventListener("touchstart",r=>{r.preventDefault(),typeof i=="function"?this.listener?.(i()):(this.isButtonDown[i]=!0,t(i))}),n.addEventListener("touchcancel",r=>{r.preventDefault(),typeof i=="function"||(this.isButtonDown[i]=!1)}),n.addEventListener("touchend",r=>{r.preventDefault(),typeof i=="function"||(this.isButtonDown[i]=!1)}))};e("left",d.Left),e("right",d.Right),e("jump",d.Jump),e("down",d.Down),e("map",d.Map),e("exit",d.Escape),e("zoom-in",()=>new P(1,!0)),e("zoom-out",()=>new P(-1,!0))}toCanvasPosition(t){let e=q(t)?t.touches.item(0)||{clientX:0,clientY:0}:t;return s.scale(new s(e.clientX-this.canvas.offsetLeft+window.scrollX-this.canvas.clientWidth/2,e.clientY-this.canvas.offsetTop+window.scrollY-this.canvas.clientHeight/2),this.canvas.width/this.canvas.clientWidth*k/k)}getInputState(){return new J(this.isButtonDown,this.mousePosition,this.leftClicking,this.rightClicking)}};var S=Symbol("real-canvas");function St(){let a=document.getElementById("canvas");if(!(a instanceof HTMLCanvasElement))throw new Error("Could not find canvas");return a.width=k,a.height=U,a}var Z=class a{static{S}constructor(){let t=new v(St());if(!(t instanceof v))throw Error("No canvas found!");this[S]=t,this.staticWorldCanvas=v.fromScratch(1280*3,720*4),this.dynamicWorldCanvas=v.fromScratch(1280*3,720*4),this.uiCanvas=v.fromScratch(k,U),this.camera=new s(0,0)}setCamera(t){this.camera=s.diff(t,new s(1280/2,720/2))}drawCanvas(t,e,o=1280,i=720){this[S].drawImage(t,e.x,e.y,o,i,0,0,this[S].width,this[S].height)}drawToScreen(){this[S].clear(),this.drawCanvas(this.staticWorldCanvas,this.camera),this.drawCanvas(this.dynamicWorldCanvas,this.camera),this.drawCanvas(this.uiCanvas,new s(0,0),1280,720)}static{this.instance=null}static getInstance(){return this.instance?this.instance:new a}};var Tt=1/20,Q=class{constructor(){this.lastFrameTime=0;this.gameModeManager=new B,this.inputManager=new z(t=>this.onInput(t)),this.screenManager=new Z,this.lastFrameTime=performance.now()}start(){this.inputManager.init(),requestAnimationFrame(()=>this.mainLoop())}onInput(t){this.gameModeManager.onInput(t)}mainLoop(){let t=performance.now(),e=Math.min((t-this.lastFrameTime)/1e3,Tt);this.gameModeManager.update(e,this.inputManager.getInputState()),this.gameModeManager.draw(this.screenManager),this.screenManager.drawToScreen(),requestAnimationFrame(()=>this.mainLoop()),this.lastFrameTime=t}},Dt=()=>{new Q().start()};window.onload=()=>{Dt()};})();
//# sourceMappingURL=index.js.map
